(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     32816,        829]
NotebookOptionsPosition[     32076,        800]
NotebookOutlinePosition[     32419,        815]
CellTagsIndexPosition[     32376,        812]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"Quit", "[", "]"}], ";"}]], "Input",
 CellChangeTimes->{{3.6955712699265676`*^9, 3.695571273750719*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"SAC", ",", " ", 
    RowBox[{
    "applied", " ", "to", " ", "the", " ", "Cart", " ", "Pendulum", " ", 
     "System"}], ",", " ", 
    RowBox[{
    "outlined", " ", "in", " ", 
     "\"\<Sequential Action Control: Closed-Form Optimal Control for \
Nonlinear and Nonsmooth Systems\>\""}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Cart", " ", "Pendulum", " ", "Example"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"vary", " ", "Q"}], ",", " ", "P", ",", " ", "R", ",", " ", 
    "\[Alpha]d", ",", " ", "\[Gamma]"}], " ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "Variables", " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"q", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\[Theta]", "[", "t", "]"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\[Theta]", "'"}], "[", "t", "]"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"x", "[", "t", "]"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"x", "'"}], "[", "t", "]"}], "}"}]}], "}"}]}], ";"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"Configuration", " ", 
     RowBox[{"Variables", " ", "/", " ", "States"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"qd", " ", "=", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "0", "}"}], ",", 
       RowBox[{"{", "0", "}"}], ",", " ", 
       RowBox[{"{", "0", "}"}], ",", 
       RowBox[{"{", "0", "}"}]}], "}"}]}], ";"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Desired", " ", "Values", " ", "of", " ", "Configuration", " ", 
     "Variables"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Alpha]d", " ", "=", " ", 
     RowBox[{"-", "1000"}]}], ";"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"desired", " ", "value"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Gamma]", " ", "=", " ", 
     RowBox[{"-", "8"}]}], ";"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"\[Gamma]", " ", 
     RowBox[{"\[Epsilon]", " ", "[", 
      RowBox[{
       RowBox[{"-", "15"}], ",", 
       RowBox[{"-", "1"}]}], "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Q", " ", "=", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"200", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
       "\[IndentingNewLine]", "       ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
       "\[IndentingNewLine]", "       ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "/", "2"}], ")"}], "*", 
            RowBox[{"x", "[", "t", "]"}]}], ")"}], "^", "8"}], ",", "0"}], 
        "}"}], ",", "\[IndentingNewLine]", "       ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", "0", ",", "50"}], "}"}]}], "}"}]}], ";"}],
    " ", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"matrix", " ", "in", " ", "incremental", " ", "cost"}], ",", " ",
      "l1"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Pg", " ", "=", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
       "\[IndentingNewLine]", "         ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "1", ",", "0", ",", "0"}], "}"}], ",", 
       "\[IndentingNewLine]", "         ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", "1", ",", "0"}], "}"}], ",", 
       "\[IndentingNewLine]", "         ", 
       RowBox[{"{", 
        RowBox[{"0", ",", "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], ";"}], 
   " ", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"matrix", " ", "in", " ", "terminal", " ", "cost"}], ",", " ", 
     "m"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"R", " ", "=", " ", 
     RowBox[{"{", "0.3", "}"}]}], ";"}], " ", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", "Parameters", " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[CapitalDelta]Jmin", " ", "=", " ", 
     RowBox[{"10", "^", 
      RowBox[{"-", "3"}]}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"minimum", " ", "change", " ", "in", " ", "cost"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"tcurr", " ", "=", " ", "0.4"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"current", " ", "time"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"\[CapitalDelta]tinit", " ", "=", " ", "0.1"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"default", " ", "control", " ", "duration"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"u1", " ", "=", " ", "1"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"nominal", " ", "control"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"w", " ", "=", " ", "0.1"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"scale", " ", "factor"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"T", " ", "=", " ", "1.5"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"prediction", " ", "horizon"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"ts", " ", "=", " ", "0.01"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"sampling", " ", "time"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"tcalc", " ", "=", " ", "0.1"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{
     "max", " ", "time", " ", "for", " ", "iterative", " ", "control", " ", 
      "calculations"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"kmax", " ", "=", " ", "100"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"max", " ", "backtracking", " ", "iterations"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"h", " ", "=", " ", "2"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"length", " ", "of", " ", "pendulum"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"g", " ", "=", " ", "9.81"}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"gravitational", " ", "constant"}], " ", "*)"}], 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{"Cart", " ", "Pendulum", " ", 
      RowBox[{"Dynamics", "  ", "--"}], " ", "Output", " ", "q", " ", "and", 
      " ", "\[Rho]"}], " ", "*)"}], " ", 
    RowBox[{"(*", " ", "4", " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"t0", " ", "=", " ", "tcurr"}], ";"}], " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"tf", " ", "=", "  ", 
     RowBox[{"tcurr", "+", "T"}]}], ";"}], " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"u", " ", "=", " ", "1"}], ";", " ", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"because", " ", "ac"}], " ", "=", " ", 
      RowBox[{
       RowBox[{"u", " ", 
        RowBox[{"(", 
         RowBox[{"~", "13"}], ")"}], " ", "and", " ", "u1"}], " ", "=", " ", 
       RowBox[{"0", " ", 
        RowBox[{"(", 
         RowBox[{"~", "31"}], ")"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"f", "=", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\[Theta]", "'"}], "[", "t", "]"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"g", "/", "h"}], ")"}], "*", 
          RowBox[{"Sin", "[", 
           RowBox[{"\[Theta]", "[", "t", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"u", "/", "h"}], ")"}], "*", 
          RowBox[{"Cos", "[", 
           RowBox[{"\[Theta]", "[", "t", "]"}], "]"}]}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"x", "'"}], "[", "t", "]"}], "}"}], ",", 
       RowBox[{"{", "u", "}"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"qsol", " ", "=", " ", 
     RowBox[{"NDSolve", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"\[Theta]", "''"}], "[", "t", "]"}], " ", "\[Equal]", " ", 
          RowBox[{"f", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"x", "''"}], "[", "t", "]"}], "\[Equal]", 
          RowBox[{"f", "[", 
           RowBox[{"[", 
            RowBox[{"4", ",", "1"}], "]"}], "]"}]}], ",", " ", 
         RowBox[{
          RowBox[{"\[Theta]", "[", "t0", "]"}], "\[Equal]", "Pi"}], ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"\[Theta]", "'"}], "[", "t0", "]"}], "\[Equal]", " ", 
          "0"}], ",", 
         RowBox[{
          RowBox[{"x", "[", "t0", "]"}], "\[Equal]", "0"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"x", "'"}], "[", "t0", "]"}], "\[Equal]", "0"}]}], "}"}], 
       ",", 
       RowBox[{"{", 
        RowBox[{"\[Theta]", ",", 
         RowBox[{"\[Theta]", "'"}], ",", "x", ",", 
         RowBox[{"x", "'"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "t0", ",", "tf"}], "}"}]}], "]"}]}], " ", ";"}], 
   "\[IndentingNewLine]", "\t", 
   RowBox[{
    RowBox[{
     RowBox[{"l1", "[", "t", "]"}], " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"q", "-", "qd"}], ")"}], "\[Transpose]"}], ".", "Q", ".", 
      RowBox[{"(", 
       RowBox[{"q", "-", "qd"}], ")"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\t", 
   RowBox[{
    RowBox[{
     RowBox[{"m", "[", "t", "]"}], " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"q", "-", "qd"}], ")"}], "\[Transpose]"}], ".", "Pg", ".", 
      RowBox[{"(", 
       RowBox[{"q", "-", "qd"}], ")"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dfdx", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"D", "[", 
          RowBox[{"f", ",", 
           RowBox[{"q", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], "]"}], "\[Transpose]"}], "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "4"}], "}"}]}], "]"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"put", " ", "in", " ", "desired", " ", "form"}], " ", "*)"}], 
    RowBox[{"\[Rho]sol", " ", "=", " ", 
     RowBox[{"NDSolve", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"\[Rho]", "'"}], "[", "t", "]"}], " ", "\[Equal]", " ", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Grad", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"l1", "[", "t", "]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}], ",", 
                    RowBox[{
                    RowBox[{"q", "\[Transpose]"}], "[", 
                    RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "/.", "qsol"}], 
                 ")"}], "[", 
                RowBox[{"[", "1", "]"}], "]"}], ")"}], "\[Transpose]"}], 
             ")"}]}], "-", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"dfdx", "/.", 
              RowBox[{"qsol", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], ")"}], ".", 
            RowBox[{"\[Rho]", "[", "t", "]"}]}]}]}], ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"\[Rho]", "[", "tf", "]"}], "\[Equal]", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Grad", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"m", "[", "t", "]"}], "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"q", "\[Transpose]"}], "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "/.", "qsol"}], 
              ")"}], "\[Transpose]"}], ")"}]}], "/.", 
          RowBox[{"t", "\[Rule]", "tf"}]}]}], "}"}], ",", 
       RowBox[{"{", "\[Rho]", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "t0", ",", "tf"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"SAC", " ", "Algorithm"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"While", "[", 
     RowBox[{
      RowBox[{"tcurr", "<", "Infinity"}], ",", " ", 
      RowBox[{"(*", " ", "1", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"t0", " ", "=", " ", "tcurr"}], ";", " ", 
       RowBox[{"(*", " ", "2", " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"tf", " ", "=", "  ", 
        RowBox[{"tcurr", "+", "T"}]}], ";"}]}], " ", 
     RowBox[{"(*", " ", "2", " ", "*)"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "use", " ", "feedback", " ", "to", " ", "initialize", " ", "xinit"}], 
     " ", "=", " ", 
     RowBox[{"x", 
      RowBox[{"(", "t0", ")"}]}]}], "  ", "*)"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"3", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"simulate", " ", 
     RowBox[{"(", 
      RowBox[{"x", ",", " ", "\[Rho]"}], ")"}], " ", "from", " ", "f1", " ", 
     "for", " ", "t", " ", 
     RowBox[{"\[Epsilon]", " ", "[", 
      RowBox[{"t0", ",", "tf"}], "]"}]}], " ", "*)"}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"4", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"J1init", " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"1", "/", "2"}], ")"}], "*", 
       RowBox[{"NIntegrate", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"l1", "[", "t", "]"}], "^", "2"}], ")"}], "/.", 
            "qsol"}], ")"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"t", ",", "t0", ",", "tf"}], "}"}]}], "]"}]}], "+", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"1", "/", "2"}], ")"}], "*", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"m", "[", "t", "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "1"}], "]"}], "]"}], "/.", "qsol"}], "/.", 
          RowBox[{"t", "\[Rule]", "tf"}]}], ")"}], "^", "2"}]}]}]}], ";", 
    RowBox[{"(*", " ", 
     RowBox[{"compute", " ", "initial", " ", "cost"}], " ", "*)"}], " ", 
    RowBox[{"(*", " ", 
     RowBox[{"5", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{"Print", "[", 
     RowBox[{"\"\<J1init = \>\"", ",", " ", "J1init"}], "]"}], ";"}], " ", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Alpha]d", " ", "=", " ", 
     RowBox[{"\[Gamma]", "*", "J1init"}]}], ";", 
    RowBox[{"(*", " ", 
     RowBox[{"\[Gamma]", " ", 
      RowBox[{"\[Epsilon]", " ", "[", 
       RowBox[{
        RowBox[{"-", "15"}], ",", 
        RowBox[{"-", "1"}]}], "]"}]}], " ", "*)"}], 
    RowBox[{"(*", " ", "6", " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"H", "[", "t", "]"}], " ", "=", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "0", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Cos", "[", 
          RowBox[{"\[Theta]", "[", "t", "]"}], "]"}], "/", "h"}], "}"}], ",", 
       RowBox[{"{", "0", "}"}], ",", 
       RowBox[{"{", "1", "}"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[CapitalLambda]", " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"H", "[", "t", "]"}], "\[Transpose]"}], ".", "\[Rho]", ".", 
      RowBox[{"\[Rho]", "\[Transpose]"}], ".", 
      RowBox[{"H", "[", "t", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"u2", " ", "=", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"\[CapitalLambda]", "+", 
            RowBox[{"R", "\[Transpose]"}]}], ")"}], "^", 
          RowBox[{"-", "1"}]}], ")"}], ".", 
        RowBox[{"[", 
         RowBox[{
          RowBox[{"\[CapitalLambda]", ".", "u1"}], "+", 
          RowBox[{
           RowBox[{
            RowBox[{"h", "[", "x", "]"}], "\[Transpose]"}], ".", "\[Rho]", 
           ".", "\[Alpha]d"}]}], "]"}]}]}], ";", 
      RowBox[{"(*", " ", 
       RowBox[{"Compute", " ", "u2", " ", "from", " ", 
        RowBox[{"(", 
         RowBox[{"x", ",", " ", "\[Rho]"}], ")"}], " ", "using", " ", 
        "Theorem", " ", "1"}], " ", "*)"}], 
      RowBox[{"(*", " ", "7", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Specify", "/", "Search"}], " ", "for", " ", "time", " ", 
          "\[Tau]"}], " ", ">", " ", 
         RowBox[{"t0", " ", "+", " ", "tcalc"}]}], ",", " ", 
        RowBox[{"to", " ", "apply", " ", "u2"}]}], " ", "*)"}], " ", 
      RowBox[{"(*", " ", 
       RowBox[{"8", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Saturate", " ", "u2", 
        RowBox[{"(", "\[Tau]", ")"}]}], " ", "*)"}], " ", 
      RowBox[{"(*", " ", 
       RowBox[{"9", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"k", " ", "=", " ", "0"}], ";", " ", 
      RowBox[{"(*", " ", "10", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"J1new", " ", "=", " ", "Infinity"}], ";", " ", 
      RowBox[{"(*", " ", "10", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"J1new", " ", "-", " ", "J1init"}], " ", ">", " ", 
            "\[CapitalDelta]Jmin"}], "  ", "&&", " ", 
           RowBox[{"k", "\[LessEqual]", " ", "kmax"}]}], ",", " ", 
          RowBox[{"(*", " ", "11", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"\[Lambda]", " ", "=", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"w", "^", "k"}], ")"}], "*", "\[CapitalDelta]tinit"}]}],
            " ", ";", " ", 
           RowBox[{"(*", " ", "12", " ", "*)"}], " ", 
           RowBox[{"(*", " ", 
            RowBox[{"brief", " ", "duration"}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"\[Tau]0", ",", "\[Tau]f"}], "}"}], " ", "=", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\[Tau]", "-", 
               RowBox[{"\[Lambda]", "/", "2"}]}], ",", " ", 
              RowBox[{"\[Tau]", "+", 
               RowBox[{"\[Lambda]", "/", "2"}]}]}], "}"}]}], ";", " ", 
           RowBox[{"(*", " ", "13", " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "Resimulate", " ", "x", " ", "applying", " ", "f2", " ", "for", 
             " ", "t", " ", 
             RowBox[{"\[Epsilon]", " ", "[", 
              RowBox[{"\[Tau]0", ",", "\[Tau]f"}], "]"}]}], " ", "*)"}], " ", 
           RowBox[{"(*", " ", 
            RowBox[{"14", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"\[CapitalDelta]J1", " ", "=", " ", 
            RowBox[{"\[Alpha]d", ".", "\[Lambda]"}]}], ";", " ", 
           RowBox[{"(*", " ", "15", " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"J1new", " ", "=", " ", 
            RowBox[{"J1init", " ", "+", " ", "\[CapitalDelta]J1"}]}], ";", 
           " ", 
           RowBox[{"(*", " ", 
            RowBox[{"Compute", " ", "new", " ", "cost", " ", "J1new"}], " ", 
            "*)"}], " ", 
           RowBox[{"(*", " ", 
            RowBox[{"15", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"k", " ", "=", " ", 
            RowBox[{"k", " ", "+", " ", "1"}]}], ";"}]}], " ", 
         RowBox[{"(*", " ", "16", " ", "*)"}], "\[IndentingNewLine]", "]"}], 
        "\[IndentingNewLine]", 
        RowBox[{"u1", "[", "t", "]"}]}], " ", "=", " ", 
       RowBox[{
        RowBox[{"u2", "[", "\[Tau]", "]"}], " ", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"for", " ", "all", " ", "t", " ", 
           RowBox[{"\[Epsilon]", " ", "[", 
            RowBox[{"\[Tau]0", ",", "\[Tau]f"}], "]"}]}], " ", 
          "\[SquareIntersection]", " ", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"t0", " ", "+", " ", "tcalc"}], ",", " ", 
            RowBox[{"t0", " ", "+", " ", "ts", " ", "+", " ", "tcalc"}]}], 
           "]"}]}], " ", "*)"}], " ", 
        RowBox[{"(*", " ", "17", " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<u2* = \>\"", ",", " ", "u2"}], "]"}]}]}], ";", " ", 
      RowBox[{"(*", " ", 
       RowBox[{"send", " ", "updated", " ", "u1", " ", "to", " ", "robot"}], 
       " ", "*)"}], 
      RowBox[{"(*", " ", 
       RowBox[{"18", "!"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{"tcurr", "<", 
         RowBox[{"t0", "+", 
          RowBox[{"ts", " ", 
           RowBox[{"(*", " ", "19", " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"Print", "[", "\"\<Waiting...\>\"", "]"}]}]}]}], ";"}], 
       " ", 
       RowBox[{"(*", " ", "20", " ", "*)"}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}], "*)"}]}]}]], "Input",
 CellChangeTimes->{{3.6955713645385857`*^9, 3.6955713647062187`*^9}, {
   3.6955714323341274`*^9, 3.6955714516505356`*^9}, {3.695571632042304*^9, 
   3.6955718294234257`*^9}, {3.695572848688453*^9, 3.6955728523135366`*^9}, {
   3.6955729021807623`*^9, 3.695572904188449*^9}, {3.6955730911166496`*^9, 
   3.6955733162870646`*^9}, {3.695573419740969*^9, 3.6955735714117155`*^9}, {
   3.6955736430127153`*^9, 3.695574056748748*^9}, {3.695574089976085*^9, 
   3.6955740922357016`*^9}, {3.6955744867262754`*^9, 3.695574494780777*^9}, {
   3.6955745352480145`*^9, 3.695574593912451*^9}, {3.695574994660112*^9, 
   3.695575120941445*^9}, 3.6955751984184513`*^9, {3.695575261341833*^9, 
   3.6955754645773473`*^9}, {3.695575954292181*^9, 3.695576023441955*^9}, {
   3.6955762941006804`*^9, 3.6955763255926447`*^9}, {3.6955763850436172`*^9, 
   3.695576385429434*^9}, {3.6956552261682405`*^9, 3.6956552423817015`*^9}, {
   3.6956553659050975`*^9, 3.695655430828864*^9}, {3.6956611810605536`*^9, 
   3.695661204291134*^9}, {3.695662328999901*^9, 3.695662350921457*^9}, {
   3.6956628018474417`*^9, 3.6956628854285245`*^9}, {3.695663006216339*^9, 
   3.6956632291851387`*^9}, 3.6956632948333273`*^9, {3.6956633262588778`*^9, 
   3.6956633818756895`*^9}, {3.6956634390168147`*^9, 
   3.6956634822204933`*^9}, {3.6956635196320457`*^9, 
   3.6956637322204914`*^9}, {3.695737438943465*^9, 3.695737573064046*^9}, {
   3.695737613040393*^9, 3.6957376172442274`*^9}, {3.695737702278098*^9, 
   3.695737871736186*^9}, {3.695737909584967*^9, 3.6957380890344105`*^9}, {
   3.695738193771665*^9, 3.695738219643638*^9}, {3.695738340762028*^9, 
   3.6957383787410407`*^9}, {3.6957385027801514`*^9, 3.695738523463291*^9}, {
   3.695738690408945*^9, 3.6957387344433537`*^9}, {3.6957387969312344`*^9, 
   3.6957388072866726`*^9}, {3.695738840167835*^9, 3.6957389194301224`*^9}, {
   3.6957390215397263`*^9, 3.6957390693621807`*^9}, {3.695739916928217*^9, 
   3.6957399584008293`*^9}, {3.6957425229378366`*^9, 
   3.6957425587941937`*^9}, {3.6957428180948772`*^9, 3.69574282325303*^9}, {
   3.695742890906358*^9, 3.695742946779587*^9}, {3.6957429905654354`*^9, 
   3.6957430513014727`*^9}, {3.695743245911973*^9, 3.69574331624851*^9}, {
   3.6957433856019373`*^9, 3.6957435453202534`*^9}, {3.6957435771387663`*^9, 
   3.6957437329821815`*^9}, {3.6957456008069563`*^9, 
   3.6957457052505927`*^9}, {3.6968690153603883`*^9, 3.696869036224981*^9}, {
   3.69686930162644*^9, 3.6968693808862543`*^9}, {3.696869795622838*^9, 
   3.696869810099009*^9}, {3.696869848336006*^9, 3.6968698729780455`*^9}, {
   3.696869954007516*^9, 3.6968699549351397`*^9}, {3.696869989961275*^9, 
   3.696870206461383*^9}, {3.6968702405420246`*^9, 3.696870411619885*^9}, {
   3.6968717737766056`*^9, 3.696872027679414*^9}, {3.696872594951104*^9, 
   3.6968726004535923`*^9}, {3.6968728713449116`*^9, 
   3.6968729163338037`*^9}, {3.7022995344894967`*^9, 3.702299536601801*^9}, {
   3.7022995673161554`*^9, 3.7022996171014996`*^9}, {3.70230007622145*^9, 
   3.702300082587515*^9}, {3.7023005737607775`*^9, 3.70230065681317*^9}, {
   3.7023093368114214`*^9, 3.702309343032591*^9}, {3.7023093957632036`*^9, 
   3.702309418073526*^9}, {3.702309707433369*^9, 3.702309714601328*^9}, {
   3.7023099055883083`*^9, 3.702309907073283*^9}, {3.7023130890617094`*^9, 
   3.7023132595606155`*^9}, {3.7023133370804305`*^9, 
   3.7023133406480455`*^9}, {3.7023133721653643`*^9, 
   3.7023133728110433`*^9}, {3.7023134536301146`*^9, 3.702313499436167*^9}, {
   3.7023135453665714`*^9, 3.7023135468516397`*^9}, {3.7023135774036026`*^9, 
   3.702313614049203*^9}, {3.702313645362979*^9, 3.7023137033422084`*^9}, {
   3.702313768173362*^9, 3.7023137766066723`*^9}, {3.702313853027937*^9, 
   3.7023138590570726`*^9}, {3.702313968907055*^9, 3.702314100060673*^9}, {
   3.702314230864472*^9, 3.7023142580808973`*^9}, {3.7023147689909945`*^9, 
   3.702314772112092*^9}, {3.7023148047025146`*^9, 3.702314917355262*^9}, {
   3.702314962642126*^9, 3.702314995333732*^9}, 3.7023151821069975`*^9, {
   3.702315262935728*^9, 3.7023152656860266`*^9}, {3.702382785419409*^9, 
   3.702382789567474*^9}, {3.7023828277232676`*^9, 3.702382850665556*^9}, {
   3.702382915007927*^9, 3.702382934727889*^9}, {3.702382990376253*^9, 
   3.702382993816353*^9}, {3.7023839302147713`*^9, 3.7023839327049036`*^9}, {
   3.702383981400032*^9, 3.702383984872255*^9}, {3.7023842088303843`*^9, 
   3.702384284222602*^9}, {3.702384324595928*^9, 3.7023843321022825`*^9}, {
   3.702384578801558*^9, 3.7023845860011964`*^9}, {3.7023846168873854`*^9, 
   3.7023846171067886`*^9}, {3.7023846727729726`*^9, 
   3.7023846749522977`*^9}, {3.702385222233073*^9, 3.70238526516667*^9}, {
   3.7023853009370317`*^9, 3.702385472334622*^9}, {3.7023855225317793`*^9, 
   3.7023855262600007`*^9}, {3.702385623159795*^9, 3.70238571098256*^9}, {
   3.7023865165746403`*^9, 3.7023865215719557`*^9}, 3.702387095054803*^9, 
   3.7023871644691415`*^9, {3.702387212617594*^9, 3.7023872268613567`*^9}, 
   3.702387867035458*^9, {3.7023880482190733`*^9, 3.702388102196767*^9}, 
   3.7023883380867715`*^9, {3.7023884076063786`*^9, 3.7023885586016417`*^9}, {
   3.70238870154099*^9, 3.702388714340317*^9}, 3.70238899566899*^9, 
   3.702389033841301*^9, 3.702389169967203*^9, {3.7023892268149357`*^9, 
   3.7023892532461815`*^9}, {3.7023900790924253`*^9, 
   3.7023901713436193`*^9}, {3.7023904267337723`*^9, 3.7023904271589546`*^9}}],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"\<\"J1init = \"\>", "\[InvisibleSpace]", 
   RowBox[{"{", "2.6535157276339964`*^6", "}"}]}],
  SequenceForm["J1init = ", {2.6535157276339964`*^6}],
  Editable->False]], "Print",
 CellChangeTimes->{3.702388582613779*^9, 3.7023887184534817`*^9, 
  3.7023890416213045`*^9, 3.7023892395013585`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["\[Alpha]d"], "Input",
 CellChangeTimes->{{3.702389256207816*^9, 3.702389257840294*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"-", "2.122812582107197`*^7"}], "}"}]], "Output",
 CellChangeTimes->{3.702389258386836*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"H", " ", "=", " ", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", "0", "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Cos", "[", 
       RowBox[{"\[Theta]", "[", "t", "]"}], "]"}], "/", "h"}], "}"}], ",", 
    RowBox[{"{", "0", "}"}], ",", 
    RowBox[{"{", "1", "}"}]}], "}"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CapitalLambda]1", " ", "=", " ", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"H", "\[Transpose]"}], ".", 
        RowBox[{"\[Rho]", "[", "t", "]"}], ".", 
        RowBox[{
         RowBox[{"\[Rho]", "[", "t", "]"}], "\[Transpose]"}], ".", "H"}], "/.",
        "qsol"}], "/.", "\[Rho]sol"}], ")"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[CapitalLambda]", " ", "=", " ", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"H", "\[Transpose]"}], ".", 
          RowBox[{"\[Rho]", "[", "t", "]"}], ".", 
          RowBox[{
           RowBox[{"\[Rho]", "[", "t", "]"}], "\[Transpose]"}], ".", "H"}], 
         ")"}], "/.", "qsol"}], "/.", "\[Rho]sol"}], "/.", 
      RowBox[{"t", "\[Rule]", "1"}]}], ")"}], "[", 
    RowBox[{"[", 
     RowBox[{"1", ",", "1"}], "]"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"R", " ", "=", " ", "0.3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Inverse", "[", 
    RowBox[{"\[CapitalLambda]", "+", "R"}], "]"}], ".", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"\[CapitalLambda]", "*", "u1"}], "+", 
          RowBox[{
           RowBox[{
            RowBox[{"H", "\[Transpose]"}], ".", 
            RowBox[{"\[Rho]", "[", "t", "]"}]}], "*", "1000"}]}], ")"}], "/.",
         "qsol"}], "/.", "\[Rho]sol"}], "/.", 
      RowBox[{"t", "\[Rule]", "1"}]}], ")"}], "[", 
    RowBox[{"[", 
     RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"\[CapitalLambda]", "*", "u1"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"H", "\[Transpose]"}], ".", 
      RowBox[{"\[Rho]", "[", "t", "]"}]}], "*", "1000"}], "/.", "qsol"}], "/.",
    "\[Rho]sol"}], "/.", 
  RowBox[{"t", "\[Rule]", "1"}]}]}], "Input",
 CellChangeTimes->{{3.7023901829614534`*^9, 3.7023902355824947`*^9}, {
  3.702390353302899*^9, 3.7023904052630634`*^9}, {3.702390507434452*^9, 
  3.7023905756557884`*^9}, {3.7023906273650837`*^9, 3.70239085316547*^9}, {
  3.7023909182263937`*^9, 3.7023909232208543`*^9}, {3.702390958172325*^9, 
  3.7023912558781633`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", "0", "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     FractionBox["1", "2"], " ", 
     RowBox[{"Cos", "[", 
      RowBox[{"\[Theta]", "[", "t", "]"}], "]"}]}], "}"}], ",", 
   RowBox[{"{", "0", "}"}], ",", 
   RowBox[{"{", "1", "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.7023912562837453`*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"{", "5090.751528161879`", "}"}], "}"}]], "Output",
 CellChangeTimes->{3.702391256284745*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"{", 
   RowBox[{"{", 
    RowBox[{"-", "13.014747690851909`"}], "}"}], "}"}], "}"}]], "Output",
 CellChangeTimes->{3.7023912562867513`*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"{", "5090.751528161879`", "}"}], "}"}]], "Output",
 CellChangeTimes->{3.702391256287751*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"{", 
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{"-", "71349.50264831478`"}], "}"}], "}"}], "}"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.702391256289753*^9}]
}, Open  ]]
},
WindowSize->{1280, 647},
WindowMargins->{{-8, Automatic}, {Automatic, -8}},
FrontEndVersion->"11.0 for Microsoft Windows (64-bit) (July 28, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 138, 3, 30, "Input"],
Cell[CellGroupData[{
Cell[721, 27, 26914, 627, 1437, "Input"],
Cell[27638, 656, 339, 7, 27, "Print"]
}, Open  ]],
Cell[CellGroupData[{
Cell[28014, 668, 101, 1, 30, "Input"],
Cell[28118, 671, 130, 3, 33, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[28285, 679, 2758, 79, 202, "Input"],
Cell[31046, 760, 354, 11, 46, "Output"],
Cell[31403, 773, 132, 3, 30, "Output"],
Cell[31538, 778, 179, 5, 30, "Output"],
Cell[31720, 785, 132, 3, 30, "Output"],
Cell[31855, 790, 205, 7, 30, "Output"]
}, Open  ]]
}
]
*)

